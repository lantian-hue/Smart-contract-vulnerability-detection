"""
拆分合约，进行合约标记，如果合约
"""

import os
import re


def split_contract(file):
    # int1=[]
    contract=[]
    contract_tmp=[]
    f=open(file,'r',encoding='utf-8')
    lines=f.readlines()
    f.close()

    for line in lines:
        text=line.strip()
        if text.isdigit():
            # int1.append(text)
            contract.append(contract_tmp)
            contract_tmp=[]
        else:
            contract_tmp.append(text)
    contract.remove(contract[0])
    return contract

def delete_not(contract):
    contract_tmp=[]
    contract_delete=[]
    #删除日志文件中的无法编译的日志信息
    for i in range(len(contract)):
        tex=contract[i]
        text=re.findall(r'^(.*):',str(contract[i][3]))
        if text != ['CRITICAL:root']:
            contract_tmp.append(tex)
        else:
            contract_delete.append(tex)
    return contract_tmp

def read_every_contract(contract_tmp):
    contract_name=[]
    vulif=[]
    contract1=[]
    for i in range(len(contract_tmp)):
        vul=[]
        for j in range(len(contract[i])):
            if j<1:
                text=contract[i][0]
                t=re.findall(r'^./sol_149363/(.*)',text)
                contract_name.append(t)
            # print(contract[i][j])
            vu=re.findall(r'True',contract[i][j])
            if vu==['True']:
                vul.append(['1'])
        if len(vul)<=0:
            vulif.append(['0'])
        else:
            vulif.append(['1'])

    return contract_name, vulif

def save_csv(contract_name,vulif):
    import csv
    for i in range(len(contract_name)):
        f=open("contract_name.csv",'a',newline='')
        writer=csv.writer(f)
        writer.writerow(contract_name[i])
        f.close()
    for j in range(len(vulif)):
        f1=open("vulif.csv",'a',newline='')
        writer1=csv.writer(f1)
        writer1.writerow(vulif[j])
        f1.close()


if __name__ == '__main__':
    path='log.txt'
    contract=split_contract(path)
    contract_tmp=delete_not(contract)
    contract_name, vulif = read_every_contract(contract_tmp)
    save_csv(contract_name, vulif)